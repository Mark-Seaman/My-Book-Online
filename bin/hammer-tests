#!/usr/bin/env python
# Create a web page with a table

from subprocess import Popen,PIPE
from os         import environ
from os.path    import dirname,join,exists,getsize
from sys        import argv


def do_command(cmd, input=None):
    '''
    Run the command as a process and capture stdout & print it
    '''
    if input:
        p = Popen(cmd.split(), stdin=PIPE, stdout=PIPE)
        p.stdin.write(input)
        p.stdin.close()
    else:
        p = Popen(cmd.split(), stdout=PIPE)
    return  p.stdout.read()[:-1]


def anchor(doc,href,label):
    '''
    Form the html string for one <a> tag
    '''
    baseurl = '/wmd'
    return '<a href="%s/%s/%s">%s</a>' % (baseurl,doc,href,label)


def print_link(dir,doc,test,label):
    '''
    Print one column of data
    '''
    print '<td width="100px">'
    filename = test+'.'+label
    path = join(dir,doc,filename)
    #print path
    if exists(path) and getsize(path)>0:
        print anchor (doc,filename,label)
    print '</td>'


def print_row(dir,doc,test):
    '''
    Print one row of data
    '''
    print '<tr>'
    print '<td><b>%s</b></td>'%test
    for label in [ 'tst', 'out', 'correct', 'diff', 'like' ]:
        print_link(dir,doc,test,label)
    print '</tr>'


def print_html(dir,doc,table):
    '''
    Print the data table
    '''
    print '<h1>%s</h1>' % doc.replace('test','System Tests')
    print '<table>'
    for row in table:
        print_row(dir,doc,row)
    print '</table>'


# Select directory for tests
doc='test/Index'
if len(argv)>1:
    doc = argv[1]

# Deal with mill scripts
if doc.startswith('unit/'):
    command_list = 'mill-script'
else:
    command_list = 'tlist'

# List the tests and create a table
tlist = do_command(command_list)
table = tlist.split('\n')
dir = environ['pd']
print_html(dir,doc,table)
   
